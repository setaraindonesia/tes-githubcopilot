<!DOCTYPE html>
<html>
<head>
    <title>Test localStorage Events</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        #log { background: #f8f9fa; padding: 15px; height: 300px; overflow-y: auto; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test localStorage Cross-Browser Events</h1>
        
        <div class="status success">
            <strong>Instructions:</strong><br>
            1. Open this page in 2 different browsers/tabs<br>
            2. Click "Send Test Message" in one browser<br>
            3. Check if other browser receives the event<br>
            4. Check console logs for detailed info
        </div>

        <div>
            <button onclick="sendTestMessage()">Send Test Message</button>
            <button onclick="clearLog()">Clear Log</button>
            <button onclick="clearStorage()">Clear Storage</button>
        </div>

        <h3>Event Log:</h3>
        <div id="log"></div>

        <h3>Current localStorage:</h3>
        <div id="storage"></div>
    </div>

    <script>
        const log = document.getElementById('log');
        const storageDiv = document.getElementById('storage');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        function updateStorageDisplay() {
            storageDiv.innerHTML = '<pre>' + JSON.stringify(localStorage, null, 2) + '</pre>';
        }

        function sendTestMessage() {
            const message = {
                id: 'test-' + Date.now(),
                content: 'Hello from browser!',
                senderId: 'browser-' + Math.random().toString(36).substr(2, 5),
                targetUserId: 'target-user',
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('chat_message', JSON.stringify(message));
                addLog('‚úÖ Sent test message: ' + message.content);
                
                setTimeout(() => {
                    localStorage.removeItem('chat_message');
                    addLog('üóëÔ∏è Cleared message from localStorage');
                    updateStorageDisplay();
                }, 200);
                
            } catch (error) {
                addLog('‚ùå Error sending message: ' + error.message);
            }
        }

        function clearLog() {
            log.innerHTML = '';
        }

        function clearStorage() {
            localStorage.clear();
            addLog('üßπ Cleared all localStorage');
            updateStorageDisplay();
        }

        // Listen for storage events
        window.addEventListener('storage', function(e) {
            addLog('üì® Storage event received!');
            addLog('Key: ' + e.key);
            addLog('New Value: ' + e.newValue);
            addLog('Old Value: ' + e.oldValue);
            
            if (e.key === 'chat_message' && e.newValue) {
                try {
                    const data = JSON.parse(e.newValue);
                    addLog('üéâ Successfully received cross-browser message!');
                    addLog('Content: ' + data.content);
                    addLog('From: ' + data.senderId);
                } catch (error) {
                    addLog('‚ùå Error parsing message: ' + error.message);
                }
            }
            
            updateStorageDisplay();
        });

        // Initial setup
        addLog('üöÄ Browser ready - listening for storage events');
        addLog('User Agent: ' + navigator.userAgent.split(' ').pop());
        updateStorageDisplay();

        // Test if we can write to localStorage
        try {
            localStorage.setItem('test', 'working');
            localStorage.removeItem('test');
            addLog('‚úÖ localStorage is working');
        } catch (error) {
            addLog('‚ùå localStorage error: ' + error.message);
        }
    </script>
</body>
</html>

